# Referral System API Documentation

The blockchain monitor now includes a complete referral tracking system with REST API endpoints.

## Overview

The referral system tracks:
- Referral relationships between users (per pool)
- Trade volume generated by referred users
- Referral codes and their owners
- Statistics for referrers

## REST API Endpoints

Base URL: `http://localhost:3004/api/referrals`

### 1. Register Referral Code

Register a referral code for a user address.

**POST** `/register-code`

```json
{
  "code": "abc12345",
  "address": "0x..."
}
```

**Response:**
```json
{
  "success": true,
  "message": "Referral code registered successfully"
}
```

### 2. Register Referral Relationship

Register that a user was referred by someone for a specific pool.

**POST** `/register`

```json
{
  "userAddress": "0x...",
  "referralCode": "abc12345",
  "poolAddress": "0x..."
}
```

**Response:**
```json
{
  "success": true,
  "message": "Referral registered successfully"
}
```

### 3. Track Trade

Track a trade made by a referred user (automatically called by blockchain monitor).

**POST** `/track-trade`

```json
{
  "userAddress": "0x...",
  "poolAddress": "0x...",
  "tokenAddress": "0x...",
  "volumeETH": "1.5",
  "volumeUSD": "3000",
  "transactionHash": "0x...",
  "tokenSymbol": "BUN",
  "type": "buy"
}
```

### 4. Get Referral Statistics

Get referral statistics for an address.

**GET** `/stats/:address`

**Response:**
```json
{
  "address": "0x...",
  "totalReferred": 5,
  "referralsByPool": {
    "0x90666...": 3,
    "0x8Eb5C...": 2
  },
  "totalVolume": {
    "ETH": 125.5,
    "USD": 251000
  },
  "volumeByPool": {
    "0x90666...": { "ETH": 100, "USD": 200000 },
    "0x8Eb5C...": { "ETH": 25.5, "USD": 51000 }
  },
  "recentTrades": [...]
}
```

### 5. Check Referral Status

Check if a user was referred for a specific pool.

**GET** `/check/:userAddress/:poolAddress`

**Response:**
```json
{
  "isReferred": true,
  "referrer": "0x...",
  "referralCode": "abc12345",
  "timestamp": 1234567890,
  "poolAddress": "0x..."
}
```

### 6. Get Referrals by Code

Get all users referred by a specific code.

**GET** `/code/:code/:poolAddress?`

The `poolAddress` parameter is optional. If provided, only returns referrals for that pool.

**Response:**
```json
{
  "code": "abc12345",
  "referrer": "0x...",
  "referrals": [
    {
      "userAddress": "0x...",
      "poolAddress": "0x...",
      "referralKey": "0x...:0x..."
    }
  ]
}
```

## Automatic Trade Tracking

The blockchain monitor automatically:
1. Detects swap events on monitored pools
2. Checks if the trader was referred for that pool
3. Calculates trade volume in ETH and USD
4. Records the trade in the referral system

## Data Storage

All referral data is stored in JSON files:
- `/data/referrals.json` - Referral relationships
- `/data/referral_codes.json` - Code to address mappings
- `/data/referral_trades.json` - Trade history

## Pool-Specific Referrals

Important: Referrals are pool-specific. A user can be referred by different people for different pools. This allows for:
- Pool-specific referral campaigns
- Different referrers for different tokens
- Accurate commission tracking per pool

## Environment Variables

Add to your `.env` file:
```
HTTP_PORT=3004  # Port for referral API (default: 3004)
```

## Testing

1. Install dependencies:
   ```bash
   cd blockchain-monitor
   npm install
   ```

2. Start the blockchain monitor:
   ```bash
   npm start
   ```

3. Test the API:
   ```bash
   # Register a code
   curl -X POST http://localhost:3004/api/referrals/register-code \
     -H "Content-Type: application/json" \
     -d '{"code":"test123","address":"0x..."}'

   # Check stats
   curl http://localhost:3004/api/referrals/stats/0x...
   ```

## Integration with Frontend

Frontend applications can:
1. Register new referral codes for users
2. Check if a user was referred before trading
3. Display referral statistics and leaderboards
4. Track referral performance in real-time